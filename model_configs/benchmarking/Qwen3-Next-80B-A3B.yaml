ENV_VARS:
  NVTE_ALLOW_NONDETERMINISTIC_ALGO: 1
  PYTORCH_CUDA_ALLOC_CONF: expandable_segments:True
  NCCL_NVLS_ENABLE: 0
  NVTE_FUSED_ATTN: 1
  NVTE_NORM_FWD_USE_CUDNN: 1
  NVTE_NORM_BWD_USE_CUDNN: 1
  NCCL_DEBUG: VERSION

MODEL_ARGS:
  # Distributed args
  --distributed-timeout-minutes: 60
  --tensor-model-parallel-size: ${TP}
  --pipeline-model-parallel-size: ${PP}
  --num-layers-per-virtual-pipeline-stage: ${LAYERS_PER_VP}
  --expert-model-parallel-size: ${EP}
  --context-parallel-size: ${CP}
  --expert-tensor-parallel-size: 1
  --use-distributed-optimizer: true
  --no-create-attention-mask-in-dataloader: true
  --cross-entropy-loss-fusion: true
  --cross-entropy-fusion-impl: te
  --enable-experimental: true

  # Training args
  --use-mcore-models: true
  --sequence-parallel: true
  --use-flash-attn: true
  --disable-bias-linear: true
  --micro-batch-size: ${MBS}
  --global-batch-size: ${GBS}
  --train-samples: 268554688
  --exit-duration-in-mins: 230
  --manual-gc: true
  --manual-gc-interval: 5

  # Transformer Engine args
  --transformer-impl: transformer_engine

  # Data args
  --data-cache-path: ${WORKSPACE}/data_cache
  --tokenizer-type: HuggingFaceTokenizer 
  --tokenizer-model: Qwen3-Next-80B-A3B-Instruct
  --data-path: ${DATA_PATH}
  --split: 99,1,0
  --no-mmap-bin-files: true
  --num-workers: 6

  # Add network size args
  --untie-embeddings-and-output-weights: true
  --position-embedding-type: rope
  --rotary-percent: 0.25  # Qwen3-Next applies RoPE only to the first 25% of position dimensions
  --rotary-base: 10000000  # Qwen3-Next uses a larger rotary base
  --rotary-seq-len-interpolation-factor: 1
  --normalization: RMSNorm
  --apply-layernorm-1p: true  # Zero-Centered RMSNorm for Qwen3-Next
  --swiglu: true
  --norm-epsilon: 1e-06
  --num-layers: 48
  --hidden-size: 2048
  --ffn-hidden-size: 5120
  --num-attention-heads: 16
  --group-query-attention: true
  --num-query-groups: 2
  --kv-channels: 256
  --qk-layernorm: true
  --attention-output-gate: true  # Qwen3-Next applies output gate to standard attention layers
  --seq-length: ${SEQ_LEN}
  --max-position-embeddings: 262144  # Qwen3-Next-80B-A3B supports up to 256k sequence length
  --make-vocab-size-divisible-by: 1187

  # Add GDN args, which are new for Qwen3-Next
  --linear-attention-type: gated_delta_net
  --linear-attention-freq: 4  # 1 1 1 0 1 1 1 0 ..., or we can use ([1,1,1,0]*12) to represent
  --linear-conv-kernel-dim: 4
  --linear-key-head-dim: 128
  --linear-value-head-dim: 128
  --linear-num-key-heads: 16
  --linear-num-value-heads: 32

  # Add regularization args
  --attention-dropout: 0.0
  --hidden-dropout: 0.0
  --clip-grad: 1.0
  --weight-decay: 0.1
  --no-weight-decay-cond-type: qwen3_next  # Qwen3-Next applies weight decay to qk layernorm as a special case

  # Add learning rate args
  --lr-decay-samples: 255126953
  --lr-warmup-samples: 162761
  --lr: 1.2e-4
  --min-lr: 1.2e-5
  --lr-decay-style: cosine
  --adam-beta1: 0.9
  --adam-beta2: 0.95

  # Add MoE args
  --num-experts: 512
  --moe-ffn-hidden-size: 512
  --moe-shared-expert-intermediate-size: 512  # Qwen3-Next have a shared expert
  --moe-shared-expert-gate: true  # Qwen3-Next have a shared expert gate
  --moe-router-load-balancing-type: aux_loss
  --moe-router-topk: 10
  --moe-router-pre-softmax: false # Different from Qwen2-MoE
  --moe-grouped-gemm: ${MOE_GROUPED_GEMM}
  --moe-aux-loss-coeff: 1e-3
  --moe-token-dispatcher-type: flex
  --moe-enable-deepep: true
  --moe-permute-fusion: true
  --moe-router-dtype: fp32
  --moe-router-fusion: true

  # Add MTP args: Qwen3-Next introduces one MTP layer
  --mtp-num-layers: 1
  --mtp-loss-scaling-factor: 0.1

  # Add validation args
  --eval-iters: 32
  --eval-interval: 500

  # Add checkpointing args
  --finetune: true
  --auto-detect-ckpt-format: true
  --load: ${LOAD_PATH}
  --save: ${OUTPUT_PATH}/checkpoints
  --save-interval: 50
  --dist-ckpt-strictness: log_all

  # Add initialization args
  --init-method-std: 0.02

  # Add logging args
  --log-timers-to-tensorboard: true
  --log-memory-to-tensorboard: true
  --log-num-zeros-in-grad: true
  --log-params-norm: true
  --log-validation-ppl-to-tensorboard: true
  --log-throughput: true
  --log-interval: 1
  --tensorboard-dir: ${OUTPUT_PATH}/tensorboard
  --wandb-project: ${WANDB_PROJECT}
  --wandb-exp-name: Qwen3-Next-80B-A3B-TP${TP}PP${PP}EP${EP}CP${CP}VPP${VPP}-MBS${MBS}GBS${GBS}-${COMMENT}

  # Add mixed precision args
  --bf16: true
